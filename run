#!/bin/sh
set -e
IFS=$'\n\t'

check_tfvars() {
    if [ ! -f "terraform.tfvars" ]; then
        yellow "terraform.tfvars not found. Creating template..."
        cat > terraform.tfvars << 'TFEOF'
# Bitwarden Secrets Provider Configuration
# Required values:
api_url         = "https://api.bitwarden.com"
identity_url    = "https://identity.bitwarden.com"
organization_id = "your-organization-id-here"
TFEOF
        printf "\n"
    fi

    # Check if required values are set
    if grep -q 'api_url.*=' terraform.tfvars && \
       grep -q 'identity_url.*=' terraform.tfvars && \
       grep -q 'organization_id.*=' terraform.tfvars; then
        # Check if placeholder values are still there
        if grep -q 'your-organization-id-here' terraform.tfvars; then
            return 1  # Needs editing
        fi
        return 0  # Already configured
    fi
    return 1  # Needs editing
}

check_and_set_token() {
    if [ -z "$BW_ACCESS_TOKEN" ]; then
        yellow "\nBW_ACCESS_TOKEN is not set in your environment."
        printf "Enter your Bitwarden access token (or press Enter to skip): "
        read -r token_input
        if [ -n "$token_input" ]; then
            export BW_ACCESS_TOKEN="$token_input"
            green "BW_ACCESS_TOKEN set successfully."
        else
            yellow "Skipping token setup. You'll need to set BW_ACCESS_TOKEN manually before running."
        fi
    else
        green "BW_ACCESS_TOKEN is already set."
    fi
}

interactive() {
    cyan_bold "\n=== Bitwarden Terraform Testing ==="
    printf "\n"

    # Check and configure tfvars
    if ! check_tfvars; then
        yellow "Opening terraform.tfvars for editing..."
        editor="${EDITOR:-${VISUAL:-vi}}"
        "$editor" terraform.tfvars
        printf "\n"
        if ! check_tfvars; then
            red "Error: Required tfvars not properly configured. Aborting."
            exit 1
        fi
        green "terraform.tfvars configured successfully."
    else
        green "terraform.tfvars is already configured."
    fi

    # Check and set BW_ACCESS_TOKEN
    check_and_set_token

    # Ask user which mode to run
    printf "\n"
    cyan_bold "Select mode:"
    printf "  1) prod - Use latest released provider version\n"
    printf "  2) test - Use test provider build from a branch\n"
    printf "  3) help - Show help\n"
    printf "  4) exit - Exit\n"
    printf "\nEnter your choice (1-4): "
    read -r choice

    case "$choice" in
        1)
            green "Running the Terraform project with the latest released provider version..."
            prod
            ;;
        2)
            printf "Enter the branch name to test: "
            read -r branch_name
            if [ -z "$branch_name" ]; then
                red "Error: Branch name cannot be empty."
                exit 1
            fi
            green "Running the Terraform project with a test provider build from a specified branch..."
            test "$branch_name"
            ;;
        3)
            docs
            ;;
        4)
            cyan "Exiting."
            exit 0
            ;;
        *)
            red "Invalid choice. Please enter 1, 2, 3, or 4."
            exit 1
            ;;
    esac
}

main() {
    # If no arguments provided, run interactive mode
    if [ $# -eq 0 ]; then
        interactive
        exit 0
    fi

    if [ "$1" = "help" ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
        docs
        exit 0
    fi

    # Handle other commands here
    case "$1" in
        prod)
            green "Running the Terraform project with the latest released provider version..."
            prod
            ;;
        test)
            green "Running the Terraform project with a test provider build from a specified branch..."
            test "$2"
            ;;
        *)
            red "Unknown command: $1"
            printf "\n"
            docs
            exit 1
            ;;
    esac
}

terraform() {
    if [ -n "$TF_BINARY" ]; then
        if command -v "$TF_BINARY" >/dev/null 2>&1; then
          "$TF_BINARY" "$@"
        else
            red "Error: TF_BINARY is set to '$TF_BINARY' but that command was not found. Please ensure TF_BINARY points to a valid Terraform binary."
            exit 1
        fi
    elif command -v tofu >/dev/null 2>&1; then
        tofu "$@"
    elif command -v terraform >/dev/null 2>&1; then
        terraform "$@"
    else
        red "Error: Neither 'tofu' nor 'terraform' command found. Please install Terraform or Opentofu to run this script."
        exit 1
    fi
}

prod() {
    # Setup trap to always restore .terraformrc on exit (success or failure)
    trap cleanup_terraformrc EXIT

    # Backup existing .terraformrc to ensure we use the latest released provider version from the registry
    if [ -f "$HOME/.terraformrc" ]; then
        mv "$HOME/.terraformrc" "$HOME/.terraformrc.backup"
    fi

    terraform init -upgrade
    terraform plan
    terraform apply -auto-approve

    green_bold "Project built successfully with the latest released provider version!"
    printf "Verify the output in the 'out' directory.\n"
}

test() {
    branch_to_test="$1"

    if [ -z "$branch_to_test" ]; then
        red "Error: No branch specified for testing. Please provide the branch name as an argument."
        printf "Usage: $0 test <branch-name>\n"
        exit 1
    fi

    trap cleanup_terraformrc EXIT

    # 1. Download the latest test artifact from GH from the branch we're testing against.
    # 2. Backup the user's existing .terraformrc file (if it exists)
    # 3. Create a new .terraformrc file that points to the test artifact
    # 4. Run terraform WITHOUT `terraform init`, as doing so is an error when using local providers
    # 5. Restore the user's original .terraformrc file

    # Step 1: Download the latest test artifact from GH, using the GH CLI.
    # Example URL: https://github.com/bitwarden/terraform-provider-bitwarden-secrets/actions/runs/22188269897
    
    # use the gh CLI to get the latest successful run for the branch we're testing against, then download the artifact from that run
    latest_run_id="$(gh run list -R bitwarden/terraform-provider-bitwarden-secrets --branch "$branch_to_test" --workflow "Build" --json databaseId --jq '.[0].databaseId')"
    if [ -z "$latest_run_id" ]; then
        red "Error: No successful workflow runs found for branch '$branch_to_test'. Please ensure there is a successful run for that branch before testing."
        exit 1
    fi

    artifact_name="$(gh api "repos/bitwarden/terraform-provider-bitwarden-secrets/actions/runs/$latest_run_id/artifacts" --jq ".artifacts[].name | select(test(\"_${OS}_${ARCH}$\"))" | head -n 1)"
    if [ -z "$artifact_name" ]; then
      red "Error: No matching artifact found for ${OS}_${ARCH} in run '$latest_run_id'."
      exit 1
    fi

    # Download the artifact for the latest run
    if [ -f "/tmp/test-artifact/$artifact_name.zip" ]; then
        rm -f "/tmp/test-artifact/$artifact_name.zip"
    fi
    gh run download "$latest_run_id" -R bitwarden/terraform-provider-bitwarden-secrets --name "$artifact_name" --dir /tmp/test-artifact

    # Unzip the artifact to get the provider binary
    unzip -o "/tmp/test-artifact/$artifact_name.zip" -d /tmp/test-artifact/bin >/dev/null

    # Step 2: Backup existing .terraformrc
    if [ -f "$HOME/.terraformrc" ]; then
        cp "$HOME/.terraformrc" "$HOME/.terraformrc.backup"
    fi

    # Step 3: Create new .terraformrc for local provider
    cat > "$HOME/.terraformrc" << EOF
provider_installation {
  dev_overrides {
      "registry.terraform.io/bitwarden/bitwarden-secrets" = "/tmp/test-artifact/bin"
      "registry.opentofu.org/bitwarden/bitwarden-secrets" = "/tmp/test-artifact/bin"
  }
  direct {}
}
EOF

    # Step 4: Run terraform without init
    terraform plan
    terraform apply -auto-approve

    green_bold "Project built successfully with the test provider build from branch '$branch_to_test'!"
    printf "Verify the output in the 'out' directory.\n"
}

cleanup_terraformrc() {
    if [ -f "$HOME/.terraformrc.backup" ]; then
        mv "$HOME/.terraformrc.backup" "$HOME/.terraformrc"
    else
        rm -f "$HOME/.terraformrc"
    fi
}

OS="$(if [ "$(uname)" = "Darwin" ]; then echo "darwin"; else echo "linux"; fi)"
ARCH="$(if [ "$(uname -m)" = "x86_64" ]; then echo "amd64"; else echo "arm64"; fi)"

cyan() {
  printf "\033[36m$1\033[0m\n"
}

cyan_bold() {
  printf "\033[1;36m$1\033[0m\n"
}

green() {
  printf "\033[32m$1\033[0m\n"
}

green_bold() {
  printf "\033[1;32m$1\033[0m\n"
}

yellow() {
  printf "\033[33m$1\033[0m\n"
}

yellow_bold() {
  printf "\033[1;33m$1\033[0m\n"
}

red() {
  printf "\033[31m$1\033[0m\n"
}

red_bold() {
  printf "\033[1;31m$1\033[0m\n"
}

docs() {
  cat << EOF
Usage: $0 [OPTIONS] COMMAND

Options:
  $(cyan_bold "-h, --help")    Show this help message and exit

Commands:
  $(cyan_bold "prod")    Build the project for production
  $(cyan_bold "test")    Run tests
EOF
}

main "$@"
